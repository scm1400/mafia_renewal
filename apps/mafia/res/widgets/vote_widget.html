<!DOCTYPE html>
<html style="overflow: hidden">

<head>
    <script>
        /* create style sheet */
        const newFontStylePath = document.URL.includes('https://zep.us') ? "https://cdn-static.zep.us/static/zep-script/css/typography.css" : "https://cdn-static-stage.zep.us/static/zep-script/css/typography.css";

        document.head.appendChild(Object.assign(document.createElement("link"), {
            rel: "stylesheet",
            type: "text/css",
            href: newFontStylePath
        }));
    </script>
    <style type="text/css">
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none !important;
            font-family: 'Pretendard JP', 'Pretendard', sans-serif, Arial;
            color: #27262E;
        }

        html {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(28, 27, 31, 0.80);
            backdrop-filter: blur(2px);
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 400px;
            max-width: 100%;
            align-items: center;
            height: max-content;
        }

        .vote-container {
            width: 100%;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .vote-header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .vote-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }

        .vote-subtitle {
            font-size: 14px;
            color: #666;
        }

        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 15px;
        }

        .players-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f5f5f5;
        }

        .player-item:hover {
            background-color: #e0e0e0;
        }

        .player-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
        }

        .player-item.dead {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .player-status {
            font-size: 12px;
            color: #666;
        }

        .vote-count {
            font-weight: 600;
            font-size: 16px;
            color: #1976d2;
        }

        .vote-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background-color: #1976d2;
            color: white;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .vote-button:hover {
            background-color: #1565c0;
        }

        .vote-button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }

        .vote-results {
            width: 100%;
            margin-top: 20px;
        }

        .result-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f5f5f5;
        }

        .result-name {
            font-weight: 500;
        }

        .result-votes {
            font-weight: 600;
            color: #1976d2;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #555;
        }

        /* Î™®Î∞îÏùº Ïä§ÌÉÄÏùº */
        .mobile {
            width: 100%;
            padding: 15px;
        }

        .mobile .vote-container {
            width: 100%;
            padding: 15px;
        }

        .mobile .player-item {
            padding: 8px 10px;
        }

        .mobile .player-avatar {
            width: 30px;
            height: 30px;
            font-size: 16px;
            margin-right: 10px;
        }

        .mobile .player-name {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="vote-container">
        <div class="close-button" onclick="closeWidget()">√ó</div>
        <div class="vote-header">
            <div class="vote-title" id="vote-title">Ìà¨Ìëú</div>
            <div class="vote-subtitle" id="vote-subtitle">ÎßàÌîºÏïÑÎ°ú ÏùòÏã¨ÎêòÎäî ÏÇ¨ÎûåÏóêÍ≤å Ìà¨ÌëúÌïòÏÑ∏Ïöî</div>
        </div>
        <div class="timer" id="timer">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 30Ï¥à</div>

        <div class="players-list" id="players-list">
            <!-- ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>

        <button class="vote-button" id="vote-button" disabled>Ìà¨ÌëúÌïòÍ∏∞</button>

        <div class="vote-results" id="vote-results" style="display: none;">
            <div class="result-title">Ìà¨Ìëú Í≤∞Í≥º</div>
            <div id="results-list">
                <!-- Ìà¨Ìëú Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedPlayerId = null;
        let voteResults = {};
        let myPlayerId = null;
        let isVotePhase = true;
        let hasVoted = false;
        let remainingTime = 30;
        let timerInterval;

        let _isMobile = false;
        let _isTablet = false;
        let $contentWrapper;

        function closeWidget() {
            window.parent.postMessage({ type: "close" }, "*");
        }

        function renderPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.forEach(player => {
                if (!player.isAlive) return; // Ï£ΩÏùÄ ÌîåÎ†àÏù¥Ïñ¥Îäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå

                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${selectedPlayerId === player.id ? 'selected' : ''}`;
                playerItem.dataset.id = player.id;

                // ÏûêÍ∏∞ ÏûêÏã†ÏùÄ ÏÑ†ÌÉùÌï† Ïàò ÏóÜÏùå
                if (player.id === myPlayerId) {
                    playerItem.classList.add('dead');
                } else {
                    playerItem.addEventListener('click', () => selectPlayer(player.id));
                }

                playerItem.innerHTML = `
                    <div class="player-avatar">${player.emoji || 'üë§'}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-status">${player.id === myPlayerId ? '(ÎÇò)' : ''}</div>
                    </div>
                    <div class="vote-count" id="vote-count-${player.id}">${voteResults[player.id] ? voteResults[player.id] : ''}</div>
                `;

                playersList.appendChild(playerItem);
            });

            // Ìà¨Ìëú Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
            const voteButton = document.getElementById('vote-button');
            voteButton.disabled = !selectedPlayerId || hasVoted || !isVotePhase || selectedPlayerId === myPlayerId;
        }

        function selectPlayer(playerId) {
            if (hasVoted || !isVotePhase || playerId === myPlayerId) return;
            
            selectedPlayerId = playerId;
            renderPlayers();
        }

        function submitVote() {
            if (!selectedPlayerId || hasVoted || !isVotePhase) return;
            
            hasVoted = true;
            document.getElementById('vote-button').disabled = true;
            
            // ÏÑúÎ≤ÑÏóê Ìà¨Ìëú Í≤∞Í≥º Ï†ÑÏÜ°
            window.parent.postMessage({
                type: "vote",
                targetId: selectedPlayerId
            }, "*");
            
            // ÎßàÎã¥Ïù∏ Í≤ΩÏö∞ Ïú†Ìòπ Îä•Î†• Î∞úÎèô
            if (myRole === "madam") {
                window.parent.postMessage({
                    type: "seduce",
                    targetId: selectedPlayerId
                }, "*");
            }
            
            // Ìà¨Ìëú Í≤∞Í≥º UI ÏóÖÎç∞Ïù¥Ìä∏
            if (!voteResults[selectedPlayerId]) {
                voteResults[selectedPlayerId] = 1;
            } else {
                voteResults[selectedPlayerId]++;
            }
            
            renderPlayers();
        }

        function showVoteResults(results) {
            isVotePhase = false;
            voteResults = results;
            
            const voteResultsDiv = document.getElementById('vote-results');
            voteResultsDiv.style.display = 'block';
            
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';
            
            // Ìà¨Ìëú Ïàò Í∏∞Ï§ÄÏúºÎ°ú ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
            const sortedResults = Object.entries(results).sort((a, b) => b[1] - a[1]);
            
            sortedResults.forEach(([playerId, votes]) => {
                const player = players.find(p => p.id === playerId);
                if (!player) return;
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <div class="result-name">${player.name}</div>
                    <div class="result-votes">${votes}Ìëú</div>
                `;
                
                resultsList.appendChild(resultItem);
            });
            
            document.getElementById('vote-button').disabled = true;
            document.getElementById('vote-title').textContent = 'Ìà¨Ìëú Í≤∞Í≥º';
            document.getElementById('vote-subtitle').textContent = 'Í∞ÄÏû• ÎßéÏùÄ ÌëúÎ•º Î∞õÏùÄ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï≤òÌòïÎê©ÎãàÎã§';
            
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }

        function updateTimer() {
            remainingTime--;
            document.getElementById('timer').textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${remainingTime}Ï¥à`;
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                if (!hasVoted && selectedPlayerId) {
                    submitVote();
                }
            }
        }

        function startTimer(seconds) {
            remainingTime = seconds;
            document.getElementById('timer').textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${remainingTime}Ï¥à`;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function hideWidget() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: "0px",
                height: "0px",
            }, "*")
            window.parent.focus();
        }

        function revealWidget(moveScrollToBottom = false) {
            if (moveScrollToBottom && $contentWrapper) {
                $contentWrapper.scrollTop = $contentWrapper.scrollHeight;
            }
            if (_isMobile) {
                const rtcAndNotchHeight = 160 + parseInt(getComputedStyle(document.documentElement,).getPropertyValue("--sat"));
                window.parent.postMessage({
                    type: 'WidgetRearrange',
                    anchor: 'middle',
                    height: '100%',
                    width: '100%',
                    top: `-${parseInt(0)}px`
                }, '*')
            } else {
                window.parent.postMessage({
                    type: "WidgetRearrange",
                    anchor: "middle",
                    width: `100%`,
                    height: `100%`,
                }, "*")
            }
        }

        function fitTheSize() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: document.body.offsetWidth + 10,
                height: document.body.offsetHeight + 10,
            }, "*")
        }

        // Ïú†Ìòπ Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
        function showSeduceResult(targetName, targetJob, isMafia, enableMafiaChat) {
            // Í≤∞Í≥º Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
            const voteResultsDiv = document.getElementById('vote-results');
            voteResultsDiv.style.display = 'block';
            
            // Ìà¨Ìëú Í≤∞Í≥º Î™©Î°ù Ïà®Í∏∞Í∏∞
            const resultsList = document.getElementById('results-list');
            resultsList.style.display = 'none';
            
            // Ïú†Ìòπ Í≤∞Í≥º Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±
            const seduceResultDiv = document.createElement('div');
            seduceResultDiv.className = 'seduce-result';
            seduceResultDiv.style.padding = '15px';
            seduceResultDiv.style.backgroundColor = '#f8f8f8';
            seduceResultDiv.style.borderRadius = '8px';
            seduceResultDiv.style.marginTop = '10px';
            
            // Í≤∞Í≥º Î©îÏãúÏßÄ ÏÉùÏÑ±
            let resultMessage = `<strong>${targetName}</strong>ÎãòÏùÑ Ïú†ÌòπÌñàÏäµÎãàÎã§!<br>`;
            resultMessage += `ÎåÄÏÉÅÏùò ÏßÅÏóÖÏùÄ <strong>${targetJob}</strong>ÏûÖÎãàÎã§.<br>`;
            resultMessage += 'Îã§Ïùå Î∞§Ïóê ÎåÄÏÉÅÏùÄ Îä•Î†•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÍ≤å Îê©ÎãàÎã§.';
            
            if (isMafia) {
                resultMessage += '<br><br><span style="color: #ff4d4d;">ÎßàÌîºÏïÑÏôÄ Ï†ëÏÑ†Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!</span>';
                resultMessage += '<br><span style="color: #ff4d4d;">Îã§Ïùå Î∞§Ïóê ÎßàÌîºÏïÑÏôÄ ÎåÄÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.</span>';
            }
            
            seduceResultDiv.innerHTML = resultMessage;
            
            // Í≤∞Í≥º Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
            voteResultsDiv.appendChild(seduceResultDiv);
            
            // ÌÉÄÏù¥ÌãÄ Î≥ÄÍ≤Ω
            document.getElementById('vote-title').textContent = 'Ïú†Ìòπ Í≤∞Í≥º';
            document.getElementById('vote-subtitle').textContent = 'Ìà¨Ìëú Ï¢ÖÎ£åÍπåÏßÄ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî';
        }

        window.addEventListener('message', function(e) {
            const data = e.data;
            
            if(data.type === "setWidget"){
                _isMobile = data.isMobile;
                _isTablet = data.isTablet;
                if(data.isMobile && !data.isTablet){
                    document.body.classList.add('mobile');
                }else{
                    document.body.classList.remove('mobile');
                }
                hideWidget();
            } else if (data.type === 'init') {
                try {
                    document.body.classList.remove("hidden");
                    revealWidget();
                } catch (error) {
                    alert("An error occurred:", error);
                }
                
                players = data.players;
                myPlayerId = data.myPlayerId;
                isVotePhase = true;
                hasVoted = false;
                selectedPlayerId = null;
                voteResults = {};
                
                renderPlayers();
                
                if (data.timeLimit) {
                    startTimer(data.timeLimit);
                }
                
                // Ìà¨Ìëú Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                document.getElementById('vote-button').addEventListener('click', submitVote);
            } else if (data.type === 'updateVotes') {
                voteResults = data.votes;
                renderPlayers();
            } else if (data.type === 'showResults') {
                showVoteResults(data.results);
            } else if (data.type === 'seduceResult') {
                // ÎßàÎã¥ Ïú†Ìòπ Í≤∞Í≥º ÌëúÏãú
                showSeduceResult(data.targetName, data.targetJob, data.isMafia, data.enableMafiaChat);
            } else if (data.type === "hide") {
                hideWidget();
            } else if (data.type === "reveal") {
                revealWidget(true);
            } else if (data.type === 'hideWidget') {
                // WidgetManagerÏóêÏÑú Î≥¥ÎÇ¥Îäî Ïà®ÍπÄ Î©îÏãúÏßÄ Ï≤òÎ¶¨
                hideWidget();
            } else if (data.type === 'showWidget') {
                // WidgetManagerÏóêÏÑú Î≥¥ÎÇ¥Îäî ÌëúÏãú Î©îÏãúÏßÄ Ï≤òÎ¶¨
                revealWidget();
            }
        });

        window.addEventListener('unload', function () {
            window.parent.focus();
        });

        // Î™®Î∞îÏùº ÌôòÍ≤Ω Í∞êÏßÄ
        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();
    </script>
</body>

</html> 