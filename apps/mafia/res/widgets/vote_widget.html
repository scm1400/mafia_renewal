<!DOCTYPE html>
<html style="overflow: hidden">

<head>
    <script>
        /* create style sheet */
        const newFontStylePath = document.URL.includes('https://zep.us') ? "https://cdn-static.zep.us/static/zep-script/css/typography.css" : "https://cdn-static-stage.zep.us/static/zep-script/css/typography.css";

        document.head.appendChild(Object.assign(document.createElement("link"), {
            rel: "stylesheet",
            type: "text/css",
            href: newFontStylePath
        }));
    </script>
    <style type="text/css">
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none !important;
            font-family: 'Pretendard JP', 'Pretendard', sans-serif, Arial;
            color: #27262E;
        }

        html {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(28, 27, 31, 0.80);
            backdrop-filter: blur(2px);
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 400px;
            max-width: 100%;
            align-items: center;
            height: max-content;
        }

        .vote-container {
            width: 100%;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .vote-header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .vote-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }

        .vote-subtitle {
            font-size: 14px;
            color: #666;
        }

        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 15px;
        }

        .players-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f5f5f5;
        }

        .player-item:hover {
            background-color: #e0e0e0;
        }

        .player-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
        }

        .player-item.dead {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .player-status {
            font-size: 12px;
            color: #666;
        }

        .vote-count {
            font-weight: 600;
            font-size: 16px;
            color: #1976d2;
        }

        .vote-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background-color: #1976d2;
            color: white;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .vote-button:hover {
            background-color: #1565c0;
        }

        .vote-button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }

        .vote-results {
            width: 100%;
            margin-top: 20px;
        }

        .result-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f5f5f5;
        }

        .result-name {
            font-weight: 500;
        }

        .result-votes {
            font-weight: 600;
            color: #1976d2;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #555;
        }

        /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        .mobile {
            width: 100%;
            padding: 15px;
        }

        .mobile .vote-container {
            width: 100%;
            padding: 15px;
        }

        .mobile .player-item {
            padding: 8px 10px;
        }

        .mobile .player-avatar {
            width: 30px;
            height: 30px;
            font-size: 16px;
            margin-right: 10px;
        }

        .mobile .player-name {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="vote-container">
        <div class="close-button" onclick="closeWidget()">Ã—</div>
        <div class="vote-header">
            <div class="vote-title" id="vote-title">íˆ¬í‘œ</div>
            <div class="vote-subtitle" id="vote-subtitle">ë§ˆí”¼ì•„ë¡œ ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒì—ê²Œ íˆ¬í‘œí•˜ì„¸ìš”</div>
        </div>
        <div class="timer" id="timer">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</div>

        <div class="players-list" id="players-list">
            <!-- í”Œë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <button class="vote-button" id="vote-button" disabled>íˆ¬í‘œí•˜ê¸°</button>

        <div class="vote-results" id="vote-results" style="display: none;">
            <div class="result-title">íˆ¬í‘œ ê²°ê³¼</div>
            <div id="results-list">
                <!-- íˆ¬í‘œ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedPlayerId = null;
        let voteResults = {};
        let myPlayerId = null;
        let isVotePhase = true;
        let hasVoted = false;
        let remainingTime = 30;
        let timerInterval;

        let _isMobile = false;
        let _isTablet = false;
        let $contentWrapper;

        function closeWidget() {
            window.parent.postMessage({ type: "close" }, "*");
        }

        function renderPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.forEach(player => {
                if (!player.isAlive) return; // ì£½ì€ í”Œë ˆì´ì–´ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ

                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${selectedPlayerId === player.id ? 'selected' : ''}`;
                playerItem.dataset.id = player.id;

                // ìê¸° ìì‹ ì€ ì„ íƒí•  ìˆ˜ ì—†ìŒ
                if (player.id === myPlayerId) {
                    playerItem.classList.add('dead');
                } else {
                    playerItem.addEventListener('click', () => selectPlayer(player.id));
                }

                playerItem.innerHTML = `
                    <div class="player-avatar">${player.emoji || 'ğŸ‘¤'}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-status">${player.id === myPlayerId ? '(ë‚˜)' : ''}</div>
                    </div>
                    <div class="vote-count" id="vote-count-${player.id}">${voteResults[player.id] ? voteResults[player.id] : ''}</div>
                `;

                playersList.appendChild(playerItem);
            });

            // íˆ¬í‘œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const voteButton = document.getElementById('vote-button');
            voteButton.disabled = !selectedPlayerId || hasVoted || !isVotePhase || selectedPlayerId === myPlayerId;
        }

        function selectPlayer(playerId) {
            if (hasVoted || !isVotePhase || playerId === myPlayerId) return;
            
            selectedPlayerId = playerId;
            renderPlayers();
        }

        function submitVote() {
            if (!selectedPlayerId || hasVoted || !isVotePhase) return;
            
            hasVoted = true;
            document.getElementById('vote-button').disabled = true;
            
            // ì„œë²„ì— íˆ¬í‘œ ê²°ê³¼ ì „ì†¡
            window.parent.postMessage({
                type: "vote",
                targetId: selectedPlayerId
            }, "*");
            
            // ë§ˆë‹´ì¸ ê²½ìš° ìœ í˜¹ ëŠ¥ë ¥ ë°œë™
            if (myRole === "madam") {
                window.parent.postMessage({
                    type: "seduce",
                    targetId: selectedPlayerId
                }, "*");
            }
            
            // íˆ¬í‘œ ê²°ê³¼ UI ì—…ë°ì´íŠ¸
            if (!voteResults[selectedPlayerId]) {
                voteResults[selectedPlayerId] = 1;
            } else {
                voteResults[selectedPlayerId]++;
            }
            
            renderPlayers();
        }

        function showVoteResults(results) {
            isVotePhase = false;
            voteResults = results;
            
            const voteResultsDiv = document.getElementById('vote-results');
            voteResultsDiv.style.display = 'block';
            
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';
            
            // íˆ¬í‘œ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const sortedResults = Object.entries(results).sort((a, b) => b[1] - a[1]);
            
            sortedResults.forEach(([playerId, votes]) => {
                const player = players.find(p => p.id === playerId);
                if (!player) return;
                
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <div class="result-name">${player.name}</div>
                    <div class="result-votes">${votes}í‘œ</div>
                `;
                
                resultsList.appendChild(resultItem);
            });
            
            document.getElementById('vote-button').disabled = true;
            document.getElementById('vote-title').textContent = 'íˆ¬í‘œ ê²°ê³¼';
            document.getElementById('vote-subtitle').textContent = 'ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì€ í”Œë ˆì´ì–´ê°€ ì²˜í˜•ë©ë‹ˆë‹¤';
            
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }

        function updateTimer() {
            remainingTime--;
            document.getElementById('timer').textContent = `ë‚¨ì€ ì‹œê°„: ${remainingTime}ì´ˆ`;
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                if (!hasVoted && selectedPlayerId) {
                    submitVote();
                }
            }
        }

        function startTimer(seconds) {
            remainingTime = seconds;
            document.getElementById('timer').textContent = `ë‚¨ì€ ì‹œê°„: ${remainingTime}ì´ˆ`;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function hideWidget() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: "0px",
                height: "0px",
            }, "*")
            window.parent.focus();
        }

        function revealWidget(moveScrollToBottom = false) {
            if (moveScrollToBottom && $contentWrapper) {
                $contentWrapper.scrollTop = $contentWrapper.scrollHeight;
            }
            if (_isMobile) {
                const rtcAndNotchHeight = 160 + parseInt(getComputedStyle(document.documentElement,).getPropertyValue("--sat"));
                window.parent.postMessage({
                    type: 'WidgetRearrange',
                    anchor: 'middle',
                    height: '100%',
                    width: '100%',
                    top: `-${parseInt(0)}px`
                }, '*')
            } else {
                window.parent.postMessage({
                    type: "WidgetRearrange",
                    anchor: "middle",
                    width: `100%`,
                    height: `100%`,
                }, "*")
            }
        }

        function fitTheSize() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: document.body.offsetWidth + 10,
                height: document.body.offsetHeight + 10,
            }, "*")
        }

        // ìœ í˜¹ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showSeduceResult(targetName, targetJob, isMafia, enableMafiaChat) {
            // ê²°ê³¼ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const voteResultsDiv = document.getElementById('vote-results');
            voteResultsDiv.style.display = 'block';
            
            // íˆ¬í‘œ ê²°ê³¼ ëª©ë¡ ìˆ¨ê¸°ê¸°
            const resultsList = document.getElementById('results-list');
            resultsList.style.display = 'none';
            
            // ìœ í˜¹ ê²°ê³¼ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
            const seduceResultDiv = document.createElement('div');
            seduceResultDiv.className = 'seduce-result';
            seduceResultDiv.style.padding = '15px';
            seduceResultDiv.style.backgroundColor = '#f8f8f8';
            seduceResultDiv.style.borderRadius = '8px';
            seduceResultDiv.style.marginTop = '10px';
            
            // ê²°ê³¼ ë©”ì‹œì§€ ìƒì„±
            let resultMessage = `<strong>${targetName}</strong>ë‹˜ì„ ìœ í˜¹í–ˆìŠµë‹ˆë‹¤!<br>`;
            resultMessage += `ëŒ€ìƒì˜ ì§ì—…ì€ <strong>${targetJob}</strong>ì…ë‹ˆë‹¤.<br>`;
            resultMessage += 'ë‹¤ìŒ ë°¤ì— ëŒ€ìƒì€ ëŠ¥ë ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.';
            
            if (isMafia) {
                resultMessage += '<br><br><span style="color: #ff4d4d;">ë§ˆí”¼ì•„ì™€ ì ‘ì„ ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!</span>';
                resultMessage += '<br><span style="color: #ff4d4d;">ë‹¤ìŒ ë°¤ì— ë§ˆí”¼ì•„ì™€ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>';
            }
            
            seduceResultDiv.innerHTML = resultMessage;
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            voteResultsDiv.appendChild(seduceResultDiv);
            
            // íƒ€ì´í‹€ ë³€ê²½
            document.getElementById('vote-title').textContent = 'ìœ í˜¹ ê²°ê³¼';
            document.getElementById('vote-subtitle').textContent = 'íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
        }

        window.addEventListener('message', function(e) {
            const data = e.data;
            
            if(data.type === "setWidget"){
                _isMobile = data.isMobile;
                _isTablet = data.isTablet;
                if(data.isMobile && !data.isTablet){
                    document.body.classList.add('mobile');
                }else{
                    document.body.classList.remove('mobile');
                }
                hideWidget();
            } else if (data.type === 'init') {
                try {
                    document.body.classList.remove("hidden");
                    revealWidget();
                } catch (error) {
                    alert("An error occurred:", error);
                }
                
                players = data.players;
                myPlayerId = data.myPlayerId;
                isVotePhase = true;
                hasVoted = false;
                selectedPlayerId = null;
                voteResults = {};
                
                renderPlayers();
                
                if (data.timeLimit) {
                    startTimer(data.timeLimit);
                }
                
                // íˆ¬í‘œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                document.getElementById('vote-button').addEventListener('click', submitVote);
            } else if (data.type === 'updateVotes') {
                voteResults = data.votes;
                renderPlayers();
            } else if (data.type === 'showResults') {
                showVoteResults(data.results);
            } else if (data.type === 'seduceResult') {
                // ë§ˆë‹´ ìœ í˜¹ ê²°ê³¼ í‘œì‹œ
                showSeduceResult(data.targetName, data.targetJob, data.isMafia, data.enableMafiaChat);
            } else if (data.type === "hide") {
                hideWidget();
            } else if (data.type === "reveal") {
                revealWidget(true);
            } else if (data.type === 'hideWidget') {
                // WidgetManagerì—ì„œ ë³´ë‚´ëŠ” ìˆ¨ê¹€ ë©”ì‹œì§€ ì²˜ë¦¬
                hideWidget();
            } else if (data.type === 'showWidget') {
                // WidgetManagerì—ì„œ ë³´ë‚´ëŠ” í‘œì‹œ ë©”ì‹œì§€ ì²˜ë¦¬
                revealWidget();
            }
        });

        window.addEventListener('unload', function () {
            window.parent.focus();
        });

        // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€
        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();
    </script>
</body>

</html> 