<!DOCTYPE html>
<html style="overflow: hidden">

<head>
    <script>
        /* create style sheet */
        const newFontStylePath = document.URL.includes('https://zep.us') ? "https://cdn-static.zep.us/static/zep-script/css/typography.css" : "https://cdn-static-stage.zep.us/static/zep-script/css/typography.css";

        document.head.appendChild(Object.assign(document.createElement("link"), {
            rel: "stylesheet",
            type: "text/css",
            href: newFontStylePath
        }));
    </script>
    <style type="text/css">
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none !important;
            font-family: 'Pretendard JP', 'Pretendard', sans-serif, Arial;
            color: #27262E;
        }

        html {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(28, 27, 31, 0.80);
            backdrop-filter: blur(2px);
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 400px;
            max-width: 100%;
            align-items: center;
            height: max-content;
        }

        .action-container {
            width: 100%;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .action-header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .action-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .action-subtitle {
            font-size: 14px;
            color: #666;
        }

        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 15px;
        }

        .players-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f5f5f5;
        }

        .player-item:hover {
            background-color: #e0e0e0;
        }

        .player-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
        }

        .player-item.dead {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .player-status {
            font-size: 12px;
            color: #666;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .action-button:disabled {
            background-color: #bdbdbd !important;
            cursor: not-allowed;
        }

        .result-container {
            width: 100%;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .result-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .result-content {
            font-size: 16px;
            color: #333;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #555;
        }

        /* 역할별 스타일 */
        .mafia .action-title {
            color: #d32f2f;
        }

        .mafia .action-button {
            background-color: #d32f2f;
        }

        .mafia .action-button:hover {
            background-color: #b71c1c;
        }

        .police .action-title {
            color: #1976d2;
        }

        .police .action-button {
            background-color: #1976d2;
        }

        .police .action-button:hover {
            background-color: #1565c0;
        }

        .doctor .action-title {
            color: #388e3c;
        }

        .doctor .action-button {
            background-color: #388e3c;
        }

        .doctor .action-button:hover {
            background-color: #2e7d32;
        }

        .spy .action-title {
            color: #7b1fa2;
        }

        .spy .action-button {
            background-color: #7b1fa2;
        }

        .spy .action-button:hover {
            background-color: #6a1b9a;
        }

        .medium .action-title {
            color: #6d4c41;
        }

        .medium .action-button {
            background-color: #6d4c41;
        }

        .medium .action-button:hover {
            background-color: #5d4037;
        }

        .soldier .action-title {
            color: #546e7a;
        }

        .soldier .action-button {
            background-color: #546e7a;
        }

        .soldier .action-button:hover {
            background-color: #455a64;
        }

        .politician .action-title {
            color: #f57c00;
        }

        .politician .action-button {
            background-color: #f57c00;
        }

        .politician .action-button:hover {
            background-color: #ef6c00;
        }

        .lover .action-title {
            color: #e91e63;
        }

        .lover .action-button {
            background-color: #e91e63;
        }

        .lover .action-button:hover {
            background-color: #d81b60;
        }

        .journalist .action-title {
            color: #00acc1;
        }

        .journalist .action-button {
            background-color: #00acc1;
        }

        .journalist .action-button:hover {
            background-color: #0097a7;
        }

        .werewolf .action-title {
            color: #5d4037;
        }

        .werewolf .action-button {
            background-color: #5d4037;
        }

        .werewolf .action-button:hover {
            background-color: #4e342e;
        }

        .gangster .action-title {
            color: #455a64;
        }

        .gangster .action-button {
            background-color: #455a64;
        }

        .gangster .action-button:hover {
            background-color: #37474f;
        }

        .detective .action-title {
            color: #0288d1;
        }

        .detective .action-button {
            background-color: #0288d1;
        }

        .detective .action-button:hover {
            background-color: #0277bd;
        }

        .gravedigger .action-title {
            color: #616161;
        }

        .gravedigger .action-button {
            background-color: #616161;
        }

        .gravedigger .action-button:hover {
            background-color: #424242;
        }

        .terrorist .action-title {
            color: #d84315;
        }

        .terrorist .action-button {
            background-color: #d84315;
        }

        .terrorist .action-button:hover {
            background-color: #bf360c;
        }

        .madam .action-title {
            color: #c2185b;
        }

        .madam .action-button {
            background-color: #c2185b;
        }

        .madam .action-button:hover {
            background-color: #ad1457;
        }

        .dead .action-title {
            color: #9e9e9e;
        }

        .dead .action-button {
            background-color: #9e9e9e;
        }

        .dead .action-button:hover {
            background-color: #757575;
        }

        /* 모바일 스타일 */
        .mobile {
            width: 100%;
            padding: 15px;
        }

        .mobile .action-container {
            width: 100%;
            padding: 15px;
        }

        .mobile .player-item {
            padding: 8px 10px;
        }

        .mobile .player-avatar {
            width: 30px;
            height: 30px;
            font-size: 16px;
            margin-right: 10px;
        }

        .mobile .player-name {
            font-size: 14px;
        }

        /* 채팅 영역 스타일 */
        .chat-container {
            display: none;
            flex-direction: column;
            width: 100%;
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }

        .chat-messages {
            width: 100%;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
        }

        .chat-message.my-message {
            background-color: #e3f2fd;
            text-align: right;
        }

        .chat-message.other-message {
            background-color: #f1f1f1;
        }

        .chat-message .sender {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-message .content {
            word-break: break-word;
        }

        .chat-input-container {
            display: flex;
            width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }

        .chat-send-button {
            padding: 8px 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        .chat-send-button:hover {
            background-color: #3d8b40;
        }
    </style>
</head>

<body>
    <div class="action-container" id="action-container">
        <div class="close-button" onclick="closeWidget()">×</div>
        <div class="action-header">
            <div class="action-title" id="action-title">밤 행동</div>
            <div class="action-subtitle" id="action-subtitle">당신의 역할에 맞는 행동을 선택하세요</div>
        </div>
        <div class="timer" id="timer">남은 시간: 30초</div>

        <div class="players-list" id="players-list">
            <!-- 플레이어 목록이 여기에 동적으로 추가됩니다 -->
        </div>

        <button class="action-button" id="action-button" disabled>선택 완료</button>

        <div id="result-container" class="result-container" style="display: none;">
            <div class="result-title" id="result-title">능력 사용 결과</div>
            <div class="result-content" id="result-content"></div>
            <button id="action-again-btn"
                style="display: none; margin-top: 20px; padding: 10px 20px; background-color: #4a6cc3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                능력 다시 사용하기
            </button>
        </div>

        <!-- 채팅 컨테이너 -->
        <div class="chat-container" id="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- 메시지가 여기에 추가됩니다 -->
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="메시지 입력...">
                <button class="chat-send-button" id="chat-send-button">전송</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedPlayerId = null;
        let myPlayerId = null;
        let myRoleId = null;
        let hasActed = false;
        let remainingTime = 30;
        let timerInterval;
        let chatEnabled = false;
        let chatTarget = ""; // "lover" 또는 "dead"

        const roleActions = {
            "mafia": {
                title: "마피아 행동",
                subtitle: "죽일 플레이어를 선택하세요",
                buttonText: "살해하기",
                actionType: "kill",
                containerClass: "mafia",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
            "police": {
                title: "경찰 행동",
                subtitle: "조사할 플레이어를 선택하세요",
                buttonText: "조사하기",
                actionType: "investigate",
                containerClass: "police",
                showTargetSelector: true,
                showChat: false
            },
            "doctor": {
                title: "의사 행동",
                subtitle: "살릴 플레이어를 선택하세요",
                buttonText: "치료하기",
                actionType: "heal",
                containerClass: "doctor",
                showTargetSelector: true,
                showChat: false
            },
            "citizen": {
                title: "시민",
                subtitle: "당신은 밤에 특별한 행동을 할 수 없습니다",
                buttonText: "확인",
                actionType: "none",
                containerClass: "",
                showTargetSelector: false,
                showChat: false
            },
            "spy": {
                title: "스파이 행동",
                subtitle: "마피아인지 확인할 플레이어를 선택하세요",
                buttonText: "정보 수집하기",
                actionType: "contact",
                containerClass: "spy",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
            "medium": {
                title: "영매 능력",
                subtitle: "당신은 죽은 자들의 대화를 들을 수 있습니다",
                buttonText: "확인",
                actionType: "listen",
                containerClass: "medium",
                showTargetSelector: false,
                showChat: false,
            },
            "soldier": {
                title: "군인",
                subtitle: "당신은 마피아의 공격을 한 번 방어할 수 있습니다",
                buttonText: "확인",
                actionType: "none",
                containerClass: "soldier",
                showTargetSelector: false,
                showChat: false
            },
            "politician": {
                title: "정치인",
                subtitle: "당신은 투표로 처형되지 않습니다",
                buttonText: "확인",
                actionType: "none",
                containerClass: "politician",
                showTargetSelector: false,
                showChat: false
            },
            "lover": {
                title: "연인 행동",
                subtitle: "당신은 다른 연인과 대화할 수 있습니다",
                buttonText: "확인",
                actionType: "chat",
                containerClass: "lover",
                showTargetSelector: false,
                showChat: true,
                chatTarget: "lover"
            },
            "journalist": {
                title: "기자 행동",
                subtitle: "직업을 조사하여 공개할 플레이어를 선택하세요",
                buttonText: "특종 보도하기",
                actionType: "announce",
                containerClass: "journalist",
                showTargetSelector: true,
                showChat: false
            },
            "werewolf": {
                title: "짐승인간 행동",
                subtitle: "마피아에게 길들여질 플레이어를 선택하세요",
                buttonText: "선택하기",
                actionType: "convert",
                containerClass: "werewolf",
                showTargetSelector: true,
                showChat: false
            },
            "gangster": {
                title: "건달 행동",
                subtitle: "투표를 방해할 플레이어를 선택하세요",
                buttonText: "공갈하기",
                actionType: "block",
                containerClass: "gangster",
                showTargetSelector: true,
                showChat: false
            },
            "detective": {
                title: "사립탐정 행동",
                subtitle: "능력 사용을 추적할 플레이어를 선택하세요",
                buttonText: "추적하기",
                actionType: "track",
                containerClass: "detective",
                showTargetSelector: true,
                showChat: false
            },
            "gravedigger": {
                title: "도굴꾼",
                subtitle: "첫날 마피아에게 살해당한 플레이어의 직업을 얻습니다",
                buttonText: "확인",
                actionType: "none",
                containerClass: "gravedigger",
                showTargetSelector: false,
                showChat: false
            },
            "terrorist": {
                title: "테러리스트",
                subtitle: "처형될 때 다른 플레이어를 함께 처형합니다",
                buttonText: "확인",
                actionType: "none",
                containerClass: "terrorist",
                showTargetSelector: false,
                showChat: false
            },
            "madam": {
                title: "마담 행동",
                subtitle: "투표로 능력을 무력화할 플레이어를 선택하세요",
                buttonText: "유혹하기",
                actionType: "seduce",
                containerClass: "madam",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
        };

        function closeWidget() {
            window.parent.postMessage({ type: "close" }, "*");
        }

        function renderPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            // 현재 역할에 대한 정보 가져오기
            const roleAction = roleActions[myRoleId] || roleActions.citizen;

            // 대상 선택기가 필요 없는 경우 (시민 등)
            if (!roleAction.showTargetSelector) {
                playersList.innerHTML = `<div style="text-align: center; padding: 20px;">${roleAction.subtitle}</div>`;
                document.getElementById('action-button').disabled = false;
                document.getElementById('action-button').textContent = roleAction.buttonText;
                return;
            }

            players.forEach(player => {
                if (!player.isAlive) return; // 죽은 플레이어는 표시하지 않음
                if (player.id === myPlayerId && myRoleId !== "doctor") return; // 의사만 자기 자신을 선택할 수 있음

                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${selectedPlayerId === player.id ? 'selected' : ''}`;
                playerItem.dataset.id = player.id;

                playerItem.addEventListener('click', () => selectPlayer(player.id));

                playerItem.innerHTML = `
                    <div class="player-avatar">${player.emoji || '👤'}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}${player.id === myPlayerId ? ' (나)' : ''}</div>
                        <div class="player-status"></div>
                    </div>
                `;

                playersList.appendChild(playerItem);
            });

            // 액션 버튼 활성화/비활성화
            const actionButton = document.getElementById('action-button');
            actionButton.disabled = !selectedPlayerId && roleAction.showTargetSelector;
        }

        function selectPlayer(playerId) {
            if (hasActed) return;

            selectedPlayerId = playerId;
            renderPlayers();
        }

        function submitAction() {
            const roleAction = roleActions[myRoleId] || roleActions.citizen;

            if (!roleAction.showTargetSelector) {
                if (!roleAction.showChat) {
                    closeWidget();
                } else {
                    // 채팅 기능이 있는 직업은 위젯을 닫지 않고 채팅 UI 표시
                    document.getElementById('action-button').style.display = 'none';
                    document.getElementById('players-list').style.display = 'none';
                    initializeChat(roleAction.chatTarget);
                }
                return;
            }

            if (!selectedPlayerId && roleAction.showTargetSelector) return;

            hasActed = true;
            document.getElementById('action-button').disabled = true;

            // 서버에 액션 결과 전송
            window.parent.postMessage({
                type: roleAction.actionType,
                targetId: selectedPlayerId
            }, "*");

            // 액션 완료 메시지 표시
            document.getElementById('players-list').style.display = 'none';
            document.getElementById('action-button').style.display = 'none';

            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            document.getElementById('result-title').textContent = "행동 완료";

            let resultMessage = "";
            switch (myRoleId) {
                case "mafia":
                    resultMessage = "살해 대상이 선택되었습니다. 낮이 될 때까지 기다려주세요.";
                    break;
                case "police":
                    resultMessage = "조사 대상이 선택되었습니다. 결과는 곧 알려드립니다.";
                    break;
                case "doctor":
                    resultMessage = "치료 대상이 선택되었습니다. 낮이 될 때까지 기다려주세요.";
                    break;
                case "spy":
                    resultMessage = "정보 수집 대상이 선택되었습니다. 결과는 곧 알려드립니다.";
                    break;
                case "journalist":
                    resultMessage = "직업 조사 대상이 선택되었습니다. 결과는 다음 날 아침에 공개됩니다.";
                    break;
                case "werewolf":
                    resultMessage = "대상이 선택되었습니다. 낮이 될 때까지 기다려주세요.";
                    break;
                case "gangster":
                    resultMessage = "공갈 대상이 선택되었습니다. 해당 플레이어는 다음 날 투표할 수 없게 됩니다.";
                    break;
                case "detective":
                    resultMessage = "추적 대상이 선택되었습니다. 결과는 곧 알려드립니다.";
                    break;
                case "madam":
                    resultMessage = "유혹 대상이 선택되었습니다. 마피아인 경우 서로 대화할 수 있게 됩니다.";
                    break;
                default:
                    resultMessage = "행동이 완료되었습니다. 낮이 될 때까지 기다려주세요.";
            }

            document.getElementById('result-content').textContent = resultMessage;

            // 채팅 기능이 있는 직업은 채팅 UI 표시
            if (roleAction.showChat) {
                initializeChat(roleAction.chatTarget);
            }

            // 타이머는 계속 실행되도록 유지
            // clearInterval(timerInterval);
        }

        function initializeChat(target) {
            chatEnabled = true;
            chatTarget = target;

            // 채팅 컨테이너 표시
            document.getElementById('chat-container').style.display = 'flex';

            // 채팅 초기 메시지 표시
            const chatMessages = document.getElementById('chat-messages');

            let welcomeMessage = "";
            if (target === "lover") {
                welcomeMessage = "다른 연인들과의 채팅이 시작되었습니다. 대화는 낮이 될 때까지 계속됩니다.";
            } else if (target === "mafia") {
                welcomeMessage = "마피아 채팅이 활성화되었습니다. 마피아 팀원들과 소통할 수 있습니다.";
            }

            const systemMessage = document.createElement('div');
            systemMessage.className = 'chat-message';
            systemMessage.innerHTML = `<div class="content"><i>${welcomeMessage}</i></div>`;
            chatMessages.appendChild(systemMessage);

            // 서버에 채팅 초기화 알림
            window.parent.postMessage({
                type: "initChat",
                chatTarget: target
            }, "*");

            // 채팅 입력 이벤트 처리
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');

            const sendMessage = () => {
                const message = chatInput.value.trim();
                if (message) {
                    // 서버에 메시지 전송
                    window.parent.postMessage({
                        type: "chatMessage",
                        chatTarget: target,
                        message: message
                    }, "*");

                    addChatMessage('나', message, true);


                    // 입력 필드 초기화
                    chatInput.value = '';
                }
            };

            chatSendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

        }

        function addChatMessage(sender, content, isMyMessage = false) {
            const chatMessages = document.getElementById('chat-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isMyMessage ? 'my-message' : 'other-message'}`;

            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <div class="content">${content}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showInvestigationResult(isMafia) {
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            document.getElementById('result-title').textContent = "조사 결과";

            const targetPlayer = players.find(p => p.id === selectedPlayerId);
            const targetName = targetPlayer ? targetPlayer.name : "선택한 플레이어";

            const resultMessage = isMafia
                ? `${targetName}님은 마피아입니다!`
                : `${targetName}님은 마피아가 아닙니다.`;

            document.getElementById('result-content').textContent = resultMessage;
        }

        function showAbilityBlocked(message) {
            // 액션 컨테이너 숨기기
            document.getElementById('action-container').style.display = 'none';

            // 결과 컨테이너 표시
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            // 결과 타이틀 설정
            document.getElementById('result-title').textContent = "능력 사용 불가";

            // 결과 메시지 설정
            document.getElementById('result-content').textContent = message || "당신은 능력을 사용할 수 없습니다.";
        }

        function updateTimer() {
            remainingTime--;
            document.getElementById('timer').textContent = `남은 시간: ${remainingTime}초`;

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                if (!hasActed) {
                    submitAction();
                }
            }
        }

        function startTimer(seconds) {
            remainingTime = seconds;
            document.getElementById('timer').textContent = `남은 시간: ${remainingTime}초`;

            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function initializeRoleUI(role) {
            myRoleId = role;
            const roleAction = roleActions[role] || roleActions.citizen;

            document.getElementById('action-title').textContent = roleAction.title;
            document.getElementById('action-subtitle').textContent = roleAction.subtitle;
            document.getElementById('action-button').textContent = roleAction.buttonText;

            const container = document.getElementById('action-container');
            container.className = `action-container ${roleAction.containerClass}`;

            // 대상 선택이 필요 없는 역할인 경우 타이머 숨기기
            if (!roleAction.showTargetSelector) {
                document.getElementById('timer').style.display = 'none';
            } else {
                document.getElementById('timer').style.display = 'block';
            }

            // 채팅 기능이 있지만 확인 버튼 클릭 전에는 숨김
            document.getElementById('chat-container').style.display = 'none';
        }

        let _isMobile = false;
        let _isTablet = false;
        let $contentWrapper;

        function hideWidget() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: "0px",
                height: "0px",
            }, "*")
            window.parent.focus();
        }

        function revealWidget(moveScrollToBottom = false) {
            if (moveScrollToBottom && $contentWrapper) {
                $contentWrapper.scrollTop = $contentWrapper.scrollHeight;
            }
            if (_isMobile) {
                const rtcAndNotchHeight = 160 + parseInt(getComputedStyle(document.documentElement,).getPropertyValue("--sat"));
                window.parent.postMessage({
                    type: 'WidgetRearrange',
                    anchor: 'middle',
                    height: '100%',
                    width: '100%',
                    top: `-${parseInt(0)}px`
                }, '*')
            } else {
                window.parent.postMessage({
                    type: "WidgetRearrange",
                    anchor: "middle",
                    width: `100%`,
                    height: `100%`,
                }, "*")
            }
        }

        function fitTheSize() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: document.body.offsetWidth + 10,
                height: document.body.offsetHeight + 10,
            }, "*")
        }

        window.addEventListener('message', function (e) {
            const data = e.data;

            if (data.type === "setWidget") {
                _isMobile = data.isMobile;
                _isTablet = data.isTablet;
                if (data.isMobile && !data.isTablet) {
                    document.body.classList.add('mobile');
                } else {
                    document.body.classList.remove('mobile');
                }
                hideWidget();
            } else if (data.type === 'init') {
                try {
                    document.body.classList.remove("hidden");
                    revealWidget();
                } catch (error) {
                    alert("An error occurred:", error);
                }

                // 기존 상태 초기화
                players = data.players;
                myPlayerId = data.myPlayerId;
                myRoleId = data.role;
                hasActed = false;
                selectedPlayerId = null;

                // UI 초기화
                initializeRoleUI(myRoleId);
                renderPlayers();

                // 결과 컨테이너 초기화
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.style.display = 'none';
                }

                // 채팅 컨테이너 초기화
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer) {
                    chatContainer.style.display = 'none';
                }

                // 액션 버튼과 플레이어 목록 재표시
                document.getElementById('action-button').style.display = 'block';
                document.getElementById('players-list').style.display = 'block';
                document.getElementById('action-button').disabled = myRoleId !== 'citizen';

                // 타이머 초기화
                if (data.timeLimit) {
                    startTimer(data.timeLimit);
                }

                // 액션 버튼 이벤트 리스너 설정
                const actionButton = document.getElementById('action-button');
                // 이전 이벤트 리스너 제거
                const newActionButton = actionButton.cloneNode(true);
                actionButton.parentNode.replaceChild(newActionButton, actionButton);
                newActionButton.addEventListener('click', submitAction);
            } else if (data.type === 'investigationResult') {
                showInvestigationResult(data.isMafia);
            } else if (data.type === 'abilityBlocked') {
                showAbilityBlocked(data.message);
            } else if (data.type === "hide") {
                hideWidget();
            } else if (data.type === "reveal") {
                revealWidget(true);
            } else if (data.type === "chatMessage") {
                // 채팅 메시지 수신
                if (chatEnabled && data.chatTarget === chatTarget) {
                    addChatMessage(data.sender, data.message);
                }
            } else if (data.type === 'hideWidget') {
                // WidgetManager에서 보내는 숨김 메시지 처리
                hideWidget();
            } else if (data.type === 'showWidget') {
                // WidgetManager에서 보내는 표시 메시지 처리
                revealWidget();
            } else if (data.type === 'spyResult') {
                showSpyResult(data.targetName, data.targetJob, data.isMafia, data.canUseAgain, data.enableMafiaChat);
            }
        });

        window.addEventListener('unload', function () {
            window.parent.focus();
        });

        // 모바일 환경 감지
        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // 스파이 결과 표시 함수
        function showSpyResult(targetName, targetJob, isMafia, canUseAgain, enableMafiaChat) {
            document.getElementById('players-list').style.display = 'none';
            document.getElementById('action-button').style.display = 'none';

            // 결과창 표시
            document.getElementById('result-container').style.display = 'block';

            // 결과 타이틀 설정
            document.getElementById('result-title').textContent = "스파이 정보 수집 결과";

            // 결과 메시지 구성
            let resultMessage = `<strong>${targetName}</strong>님의 직업은 <strong>${targetJob}</strong>입니다.`;

            if (isMafia) {
                resultMessage += '<br><span style="color: #ff4d4d;">마피아 팀</span>입니다.';
            } else {
                resultMessage += '<br><span style="color: #4da6ff;">시민 팀</span>입니다.';
            }

            if (canUseAgain) {
                resultMessage += '<br><br><span style="color: #ffcc00;">마피아와 접선에 성공했습니다! 능력을 한 번 더 사용할 수 있습니다.</span>';

                // 능력 재사용 버튼 표시
                document.getElementById('action-again-btn').style.display = 'block';
                document.getElementById('action-again-btn').onclick = function () {
                    document.getElementById('players-list').style.display = 'block';
                    document.getElementById('action-button').style.display = 'block';

                    document.getElementById('result-container').style.display = 'none';
                };

                // 마피아 채팅 활성화
                if (enableMafiaChat) {
                    resultMessage += '<br><span style="color: #ffcc00;">마피아와 채팅할 수 있습니다!</span>';

                    // 마피아 채팅 초기화 (나중에 채팅 UI가 자동으로 표시됨)
                    const roleAction = roleActions["spy"];
                    roleAction.showChat = true;

                    // 서버에 채팅 초기화 메시지 전송
                    window.parent.postMessage({
                        type: "initChat",
                        chatTarget: "mafia"
                    }, "*");
                }
            } else {
                document.getElementById('action-again-btn').style.display = 'none';
            }

            // 결과 표시
            document.getElementById('result-content').innerHTML = resultMessage;
        }
    </script>
</body>

</html>