<!DOCTYPE html>
<html style="overflow: hidden">

<head>
    <script>
        /* create style sheet */
        const newFontStylePath = document.URL.includes('https://zep.us') ? "https://cdn-static.zep.us/static/zep-script/css/typography.css" : "https://cdn-static-stage.zep.us/static/zep-script/css/typography.css";

        document.head.appendChild(Object.assign(document.createElement("link"), {
            rel: "stylesheet",
            type: "text/css",
            href: newFontStylePath
        }));
    </script>
    <style type="text/css">
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            user-select: none !important;
            font-family: 'Pretendard JP', 'Pretendard', sans-serif, Arial;
            color: #27262E;
        }

        html {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(28, 27, 31, 0.80);
            backdrop-filter: blur(2px);
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 400px;
            max-width: 100%;
            align-items: center;
            height: max-content;
        }

        .action-container {
            width: 100%;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .action-header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .action-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .action-subtitle {
            font-size: 14px;
            color: #666;
        }

        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 15px;
        }

        .players-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f5f5f5;
        }

        .player-item:hover {
            background-color: #e0e0e0;
        }

        .player-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
        }

        .player-item.dead {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .player-status {
            font-size: 12px;
            color: #666;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .action-button:disabled {
            background-color: #bdbdbd !important;
            cursor: not-allowed;
        }

        .result-container {
            width: 100%;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .result-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .result-content {
            font-size: 16px;
            color: #333;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #555;
        }

        /* ì—­í• ë³„ ìŠ¤íƒ€ì¼ */
        .mafia .action-title {
            color: #d32f2f;
        }

        .mafia .action-button {
            background-color: #d32f2f;
        }

        .mafia .action-button:hover {
            background-color: #b71c1c;
        }

        .police .action-title {
            color: #1976d2;
        }

        .police .action-button {
            background-color: #1976d2;
        }

        .police .action-button:hover {
            background-color: #1565c0;
        }

        .doctor .action-title {
            color: #388e3c;
        }

        .doctor .action-button {
            background-color: #388e3c;
        }

        .doctor .action-button:hover {
            background-color: #2e7d32;
        }

        .spy .action-title {
            color: #7b1fa2;
        }

        .spy .action-button {
            background-color: #7b1fa2;
        }

        .spy .action-button:hover {
            background-color: #6a1b9a;
        }

        .medium .action-title {
            color: #6d4c41;
        }

        .medium .action-button {
            background-color: #6d4c41;
        }

        .medium .action-button:hover {
            background-color: #5d4037;
        }

        .soldier .action-title {
            color: #546e7a;
        }

        .soldier .action-button {
            background-color: #546e7a;
        }

        .soldier .action-button:hover {
            background-color: #455a64;
        }

        .politician .action-title {
            color: #f57c00;
        }

        .politician .action-button {
            background-color: #f57c00;
        }

        .politician .action-button:hover {
            background-color: #ef6c00;
        }

        .lover .action-title {
            color: #e91e63;
        }

        .lover .action-button {
            background-color: #e91e63;
        }

        .lover .action-button:hover {
            background-color: #d81b60;
        }

        .journalist .action-title {
            color: #00acc1;
        }

        .journalist .action-button {
            background-color: #00acc1;
        }

        .journalist .action-button:hover {
            background-color: #0097a7;
        }

        .werewolf .action-title {
            color: #5d4037;
        }

        .werewolf .action-button {
            background-color: #5d4037;
        }

        .werewolf .action-button:hover {
            background-color: #4e342e;
        }

        .gangster .action-title {
            color: #455a64;
        }

        .gangster .action-button {
            background-color: #455a64;
        }

        .gangster .action-button:hover {
            background-color: #37474f;
        }

        .detective .action-title {
            color: #0288d1;
        }

        .detective .action-button {
            background-color: #0288d1;
        }

        .detective .action-button:hover {
            background-color: #0277bd;
        }

        .gravedigger .action-title {
            color: #616161;
        }

        .gravedigger .action-button {
            background-color: #616161;
        }

        .gravedigger .action-button:hover {
            background-color: #424242;
        }

        .terrorist .action-title {
            color: #d84315;
        }

        .terrorist .action-button {
            background-color: #d84315;
        }

        .terrorist .action-button:hover {
            background-color: #bf360c;
        }

        .madam .action-title {
            color: #c2185b;
        }

        .madam .action-button {
            background-color: #c2185b;
        }

        .madam .action-button:hover {
            background-color: #ad1457;
        }

        .dead .action-title {
            color: #9e9e9e;
        }

        .dead .action-button {
            background-color: #9e9e9e;
        }

        .dead .action-button:hover {
            background-color: #757575;
        }

        /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
        .mobile {
            width: 100%;
            padding: 15px;
        }

        .mobile .action-container {
            width: 100%;
            padding: 15px;
        }

        .mobile .player-item {
            padding: 8px 10px;
        }

        .mobile .player-avatar {
            width: 30px;
            height: 30px;
            font-size: 16px;
            margin-right: 10px;
        }

        .mobile .player-name {
            font-size: 14px;
        }

        /* ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .chat-container {
            display: none;
            flex-direction: column;
            width: 100%;
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }

        .chat-messages {
            width: 100%;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
        }

        .chat-message.my-message {
            background-color: #e3f2fd;
            text-align: right;
        }

        .chat-message.other-message {
            background-color: #f1f1f1;
        }

        .chat-message .sender {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-message .content {
            word-break: break-word;
        }

        .chat-input-container {
            display: flex;
            width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }

        .chat-send-button {
            padding: 8px 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        .chat-send-button:hover {
            background-color: #3d8b40;
        }
    </style>
</head>

<body>
    <div class="action-container" id="action-container">
        <div class="close-button" onclick="closeWidget()">Ã—</div>
        <div class="action-header">
            <div class="action-title" id="action-title">ë°¤ í–‰ë™</div>
            <div class="action-subtitle" id="action-subtitle">ë‹¹ì‹ ì˜ ì—­í• ì— ë§ëŠ” í–‰ë™ì„ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div class="timer" id="timer">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</div>

        <div class="players-list" id="players-list">
            <!-- í”Œë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <button class="action-button" id="action-button" disabled>ì„ íƒ ì™„ë£Œ</button>

        <div id="result-container" class="result-container" style="display: none;">
            <div class="result-title" id="result-title">ëŠ¥ë ¥ ì‚¬ìš© ê²°ê³¼</div>
            <div class="result-content" id="result-content"></div>
            <button id="action-again-btn"
                style="display: none; margin-top: 20px; padding: 10px 20px; background-color: #4a6cc3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ëŠ¥ë ¥ ë‹¤ì‹œ ì‚¬ìš©í•˜ê¸°
            </button>
        </div>

        <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
        <div class="chat-container" id="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                <button class="chat-send-button" id="chat-send-button">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedPlayerId = null;
        let myPlayerId = null;
        let myRoleId = null;
        let hasActed = false;
        let remainingTime = 30;
        let timerInterval;
        let chatEnabled = false;
        let chatTarget = ""; // "lover" ë˜ëŠ” "dead"

        const roleActions = {
            "mafia": {
                title: "ë§ˆí”¼ì•„ í–‰ë™",
                subtitle: "ì£½ì¼ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì‚´í•´í•˜ê¸°",
                actionType: "kill",
                containerClass: "mafia",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
            "police": {
                title: "ê²½ì°° í–‰ë™",
                subtitle: "ì¡°ì‚¬í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì¡°ì‚¬í•˜ê¸°",
                actionType: "investigate",
                containerClass: "police",
                showTargetSelector: true,
                showChat: false
            },
            "doctor": {
                title: "ì˜ì‚¬ í–‰ë™",
                subtitle: "ì‚´ë¦´ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì¹˜ë£Œí•˜ê¸°",
                actionType: "heal",
                containerClass: "doctor",
                showTargetSelector: true,
                showChat: false
            },
            "citizen": {
                title: "ì‹œë¯¼",
                subtitle: "ë‹¹ì‹ ì€ ë°¤ì— íŠ¹ë³„í•œ í–‰ë™ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "none",
                containerClass: "",
                showTargetSelector: false,
                showChat: false
            },
            "spy": {
                title: "ìŠ¤íŒŒì´ í–‰ë™",
                subtitle: "ë§ˆí”¼ì•„ì¸ì§€ í™•ì¸í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì •ë³´ ìˆ˜ì§‘í•˜ê¸°",
                actionType: "contact",
                containerClass: "spy",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
            "medium": {
                title: "ì˜ë§¤ ëŠ¥ë ¥",
                subtitle: "ë‹¹ì‹ ì€ ì£½ì€ ìë“¤ì˜ ëŒ€í™”ë¥¼ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "listen",
                containerClass: "medium",
                showTargetSelector: false,
                showChat: false,
            },
            "soldier": {
                title: "êµ°ì¸",
                subtitle: "ë‹¹ì‹ ì€ ë§ˆí”¼ì•„ì˜ ê³µê²©ì„ í•œ ë²ˆ ë°©ì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "none",
                containerClass: "soldier",
                showTargetSelector: false,
                showChat: false
            },
            "politician": {
                title: "ì •ì¹˜ì¸",
                subtitle: "ë‹¹ì‹ ì€ íˆ¬í‘œë¡œ ì²˜í˜•ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "none",
                containerClass: "politician",
                showTargetSelector: false,
                showChat: false
            },
            "lover": {
                title: "ì—°ì¸ í–‰ë™",
                subtitle: "ë‹¹ì‹ ì€ ë‹¤ë¥¸ ì—°ì¸ê³¼ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "chat",
                containerClass: "lover",
                showTargetSelector: false,
                showChat: true,
                chatTarget: "lover"
            },
            "journalist": {
                title: "ê¸°ì í–‰ë™",
                subtitle: "ì§ì—…ì„ ì¡°ì‚¬í•˜ì—¬ ê³µê°œí•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "íŠ¹ì¢… ë³´ë„í•˜ê¸°",
                actionType: "announce",
                containerClass: "journalist",
                showTargetSelector: true,
                showChat: false
            },
            "werewolf": {
                title: "ì§ìŠ¹ì¸ê°„ í–‰ë™",
                subtitle: "ë§ˆí”¼ì•„ì—ê²Œ ê¸¸ë“¤ì—¬ì§ˆ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì„ íƒí•˜ê¸°",
                actionType: "convert",
                containerClass: "werewolf",
                showTargetSelector: true,
                showChat: false
            },
            "gangster": {
                title: "ê±´ë‹¬ í–‰ë™",
                subtitle: "íˆ¬í‘œë¥¼ ë°©í•´í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ê³µê°ˆí•˜ê¸°",
                actionType: "block",
                containerClass: "gangster",
                showTargetSelector: true,
                showChat: false
            },
            "detective": {
                title: "ì‚¬ë¦½íƒì • í–‰ë™",
                subtitle: "ëŠ¥ë ¥ ì‚¬ìš©ì„ ì¶”ì í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ì¶”ì í•˜ê¸°",
                actionType: "track",
                containerClass: "detective",
                showTargetSelector: true,
                showChat: false
            },
            "gravedigger": {
                title: "ë„êµ´ê¾¼",
                subtitle: "ì²«ë‚  ë§ˆí”¼ì•„ì—ê²Œ ì‚´í•´ë‹¹í•œ í”Œë ˆì´ì–´ì˜ ì§ì—…ì„ ì–»ìŠµë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "none",
                containerClass: "gravedigger",
                showTargetSelector: false,
                showChat: false
            },
            "terrorist": {
                title: "í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸",
                subtitle: "ì²˜í˜•ë  ë•Œ ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ í•¨ê»˜ ì²˜í˜•í•©ë‹ˆë‹¤",
                buttonText: "í™•ì¸",
                actionType: "none",
                containerClass: "terrorist",
                showTargetSelector: false,
                showChat: false
            },
            "madam": {
                title: "ë§ˆë‹´ í–‰ë™",
                subtitle: "íˆ¬í‘œë¡œ ëŠ¥ë ¥ì„ ë¬´ë ¥í™”í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
                buttonText: "ìœ í˜¹í•˜ê¸°",
                actionType: "seduce",
                containerClass: "madam",
                showTargetSelector: true,
                showChat: false,
                chatTarget: "mafia"
            },
        };

        function closeWidget() {
            window.parent.postMessage({ type: "close" }, "*");
        }

        function renderPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            // í˜„ì¬ ì—­í• ì— ëŒ€í•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const roleAction = roleActions[myRoleId] || roleActions.citizen;

            // ëŒ€ìƒ ì„ íƒê¸°ê°€ í•„ìš” ì—†ëŠ” ê²½ìš° (ì‹œë¯¼ ë“±)
            if (!roleAction.showTargetSelector) {
                playersList.innerHTML = `<div style="text-align: center; padding: 20px;">${roleAction.subtitle}</div>`;
                document.getElementById('action-button').disabled = false;
                document.getElementById('action-button').textContent = roleAction.buttonText;
                return;
            }

            players.forEach(player => {
                if (!player.isAlive) return; // ì£½ì€ í”Œë ˆì´ì–´ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (player.id === myPlayerId && myRoleId !== "doctor") return; // ì˜ì‚¬ë§Œ ìê¸° ìì‹ ì„ ì„ íƒí•  ìˆ˜ ìˆìŒ

                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${selectedPlayerId === player.id ? 'selected' : ''}`;
                playerItem.dataset.id = player.id;

                playerItem.addEventListener('click', () => selectPlayer(player.id));

                playerItem.innerHTML = `
                    <div class="player-avatar">${player.emoji || 'ğŸ‘¤'}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name}${player.id === myPlayerId ? ' (ë‚˜)' : ''}</div>
                        <div class="player-status"></div>
                    </div>
                `;

                playersList.appendChild(playerItem);
            });

            // ì•¡ì…˜ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const actionButton = document.getElementById('action-button');
            actionButton.disabled = !selectedPlayerId && roleAction.showTargetSelector;
        }

        function selectPlayer(playerId) {
            if (hasActed) return;

            selectedPlayerId = playerId;
            renderPlayers();
        }

        function submitAction() {
            const roleAction = roleActions[myRoleId] || roleActions.citizen;

            if (!roleAction.showTargetSelector) {
                if (!roleAction.showChat) {
                    closeWidget();
                } else {
                    // ì±„íŒ… ê¸°ëŠ¥ì´ ìˆëŠ” ì§ì—…ì€ ìœ„ì ¯ì„ ë‹«ì§€ ì•Šê³  ì±„íŒ… UI í‘œì‹œ
                    document.getElementById('action-button').style.display = 'none';
                    document.getElementById('players-list').style.display = 'none';
                    initializeChat(roleAction.chatTarget);
                }
                return;
            }

            if (!selectedPlayerId && roleAction.showTargetSelector) return;

            hasActed = true;
            document.getElementById('action-button').disabled = true;

            // ì„œë²„ì— ì•¡ì…˜ ê²°ê³¼ ì „ì†¡
            window.parent.postMessage({
                type: roleAction.actionType,
                targetId: selectedPlayerId
            }, "*");

            // ì•¡ì…˜ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
            document.getElementById('players-list').style.display = 'none';
            document.getElementById('action-button').style.display = 'none';

            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            document.getElementById('result-title').textContent = "í–‰ë™ ì™„ë£Œ";

            let resultMessage = "";
            switch (myRoleId) {
                case "mafia":
                    resultMessage = "ì‚´í•´ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‚®ì´ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                    break;
                case "police":
                    resultMessage = "ì¡°ì‚¬ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê³§ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.";
                    break;
                case "doctor":
                    resultMessage = "ì¹˜ë£Œ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‚®ì´ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                    break;
                case "spy":
                    resultMessage = "ì •ë³´ ìˆ˜ì§‘ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê³§ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.";
                    break;
                case "journalist":
                    resultMessage = "ì§ì—… ì¡°ì‚¬ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ë‹¤ìŒ ë‚  ì•„ì¹¨ì— ê³µê°œë©ë‹ˆë‹¤.";
                    break;
                case "werewolf":
                    resultMessage = "ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‚®ì´ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                    break;
                case "gangster":
                    resultMessage = "ê³µê°ˆ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ í”Œë ˆì´ì–´ëŠ” ë‹¤ìŒ ë‚  íˆ¬í‘œí•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.";
                    break;
                case "detective":
                    resultMessage = "ì¶”ì  ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê³§ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.";
                    break;
                case "madam":
                    resultMessage = "ìœ í˜¹ ëŒ€ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆí”¼ì•„ì¸ ê²½ìš° ì„œë¡œ ëŒ€í™”í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.";
                    break;
                default:
                    resultMessage = "í–‰ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‚®ì´ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
            }

            document.getElementById('result-content').textContent = resultMessage;

            // ì±„íŒ… ê¸°ëŠ¥ì´ ìˆëŠ” ì§ì—…ì€ ì±„íŒ… UI í‘œì‹œ
            if (roleAction.showChat) {
                initializeChat(roleAction.chatTarget);
            }

            // íƒ€ì´ë¨¸ëŠ” ê³„ì† ì‹¤í–‰ë˜ë„ë¡ ìœ ì§€
            // clearInterval(timerInterval);
        }

        function initializeChat(target) {
            chatEnabled = true;
            chatTarget = target;

            // ì±„íŒ… ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById('chat-container').style.display = 'flex';

            // ì±„íŒ… ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
            const chatMessages = document.getElementById('chat-messages');

            let welcomeMessage = "";
            if (target === "lover") {
                welcomeMessage = "ë‹¤ë¥¸ ì—°ì¸ë“¤ê³¼ì˜ ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ëŠ” ë‚®ì´ ë  ë•Œê¹Œì§€ ê³„ì†ë©ë‹ˆë‹¤.";
            } else if (target === "mafia") {
                welcomeMessage = "ë§ˆí”¼ì•„ ì±„íŒ…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆí”¼ì•„ íŒ€ì›ë“¤ê³¼ ì†Œí†µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            }

            const systemMessage = document.createElement('div');
            systemMessage.className = 'chat-message';
            systemMessage.innerHTML = `<div class="content"><i>${welcomeMessage}</i></div>`;
            chatMessages.appendChild(systemMessage);

            // ì„œë²„ì— ì±„íŒ… ì´ˆê¸°í™” ì•Œë¦¼
            window.parent.postMessage({
                type: "initChat",
                chatTarget: target
            }, "*");

            // ì±„íŒ… ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');

            const sendMessage = () => {
                const message = chatInput.value.trim();
                if (message) {
                    // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
                    window.parent.postMessage({
                        type: "chatMessage",
                        chatTarget: target,
                        message: message
                    }, "*");

                    addChatMessage('ë‚˜', message, true);


                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    chatInput.value = '';
                }
            };

            chatSendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

        }

        function addChatMessage(sender, content, isMyMessage = false) {
            const chatMessages = document.getElementById('chat-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isMyMessage ? 'my-message' : 'other-message'}`;

            messageDiv.innerHTML = `
                <div class="sender">${sender}</div>
                <div class="content">${content}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showInvestigationResult(isMafia) {
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            document.getElementById('result-title').textContent = "ì¡°ì‚¬ ê²°ê³¼";

            const targetPlayer = players.find(p => p.id === selectedPlayerId);
            const targetName = targetPlayer ? targetPlayer.name : "ì„ íƒí•œ í”Œë ˆì´ì–´";

            const resultMessage = isMafia
                ? `${targetName}ë‹˜ì€ ë§ˆí”¼ì•„ì…ë‹ˆë‹¤!`
                : `${targetName}ë‹˜ì€ ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤.`;

            document.getElementById('result-content').textContent = resultMessage;
        }

        function showAbilityBlocked(message) {
            // ì•¡ì…˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            document.getElementById('action-container').style.display = 'none';

            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            // ê²°ê³¼ íƒ€ì´í‹€ ì„¤ì •
            document.getElementById('result-title').textContent = "ëŠ¥ë ¥ ì‚¬ìš© ë¶ˆê°€";

            // ê²°ê³¼ ë©”ì‹œì§€ ì„¤ì •
            document.getElementById('result-content').textContent = message || "ë‹¹ì‹ ì€ ëŠ¥ë ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }

        function updateTimer() {
            remainingTime--;
            document.getElementById('timer').textContent = `ë‚¨ì€ ì‹œê°„: ${remainingTime}ì´ˆ`;

            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                if (!hasActed) {
                    submitAction();
                }
            }
        }

        function startTimer(seconds) {
            remainingTime = seconds;
            document.getElementById('timer').textContent = `ë‚¨ì€ ì‹œê°„: ${remainingTime}ì´ˆ`;

            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function initializeRoleUI(role) {
            myRoleId = role;
            const roleAction = roleActions[role] || roleActions.citizen;

            document.getElementById('action-title').textContent = roleAction.title;
            document.getElementById('action-subtitle').textContent = roleAction.subtitle;
            document.getElementById('action-button').textContent = roleAction.buttonText;

            const container = document.getElementById('action-container');
            container.className = `action-container ${roleAction.containerClass}`;

            // ëŒ€ìƒ ì„ íƒì´ í•„ìš” ì—†ëŠ” ì—­í• ì¸ ê²½ìš° íƒ€ì´ë¨¸ ìˆ¨ê¸°ê¸°
            if (!roleAction.showTargetSelector) {
                document.getElementById('timer').style.display = 'none';
            } else {
                document.getElementById('timer').style.display = 'block';
            }

            // ì±„íŒ… ê¸°ëŠ¥ì´ ìˆì§€ë§Œ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì „ì—ëŠ” ìˆ¨ê¹€
            document.getElementById('chat-container').style.display = 'none';
        }

        let _isMobile = false;
        let _isTablet = false;
        let $contentWrapper;

        function hideWidget() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: "0px",
                height: "0px",
            }, "*")
            window.parent.focus();
        }

        function revealWidget(moveScrollToBottom = false) {
            if (moveScrollToBottom && $contentWrapper) {
                $contentWrapper.scrollTop = $contentWrapper.scrollHeight;
            }
            if (_isMobile) {
                const rtcAndNotchHeight = 160 + parseInt(getComputedStyle(document.documentElement,).getPropertyValue("--sat"));
                window.parent.postMessage({
                    type: 'WidgetRearrange',
                    anchor: 'middle',
                    height: '100%',
                    width: '100%',
                    top: `-${parseInt(0)}px`
                }, '*')
            } else {
                window.parent.postMessage({
                    type: "WidgetRearrange",
                    anchor: "middle",
                    width: `100%`,
                    height: `100%`,
                }, "*")
            }
        }

        function fitTheSize() {
            window.parent.postMessage({
                type: "WidgetRearrange",
                width: document.body.offsetWidth + 10,
                height: document.body.offsetHeight + 10,
            }, "*")
        }

        window.addEventListener('message', function (e) {
            const data = e.data;

            if (data.type === "setWidget") {
                _isMobile = data.isMobile;
                _isTablet = data.isTablet;
                if (data.isMobile && !data.isTablet) {
                    document.body.classList.add('mobile');
                } else {
                    document.body.classList.remove('mobile');
                }
                hideWidget();
            } else if (data.type === 'init') {
                try {
                    document.body.classList.remove("hidden");
                    revealWidget();
                } catch (error) {
                    alert("An error occurred:", error);
                }

                // ê¸°ì¡´ ìƒíƒœ ì´ˆê¸°í™”
                players = data.players;
                myPlayerId = data.myPlayerId;
                myRoleId = data.role;
                hasActed = false;
                selectedPlayerId = null;

                // UI ì´ˆê¸°í™”
                initializeRoleUI(myRoleId);
                renderPlayers();

                // ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.style.display = 'none';
                }

                // ì±„íŒ… ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer) {
                    chatContainer.style.display = 'none';
                }

                // ì•¡ì…˜ ë²„íŠ¼ê³¼ í”Œë ˆì´ì–´ ëª©ë¡ ì¬í‘œì‹œ
                document.getElementById('action-button').style.display = 'block';
                document.getElementById('players-list').style.display = 'block';
                document.getElementById('action-button').disabled = myRoleId !== 'citizen';

                // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                if (data.timeLimit) {
                    startTimer(data.timeLimit);
                }

                // ì•¡ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                const actionButton = document.getElementById('action-button');
                // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                const newActionButton = actionButton.cloneNode(true);
                actionButton.parentNode.replaceChild(newActionButton, actionButton);
                newActionButton.addEventListener('click', submitAction);
            } else if (data.type === 'investigationResult') {
                showInvestigationResult(data.isMafia);
            } else if (data.type === 'abilityBlocked') {
                showAbilityBlocked(data.message);
            } else if (data.type === "hide") {
                hideWidget();
            } else if (data.type === "reveal") {
                revealWidget(true);
            } else if (data.type === "chatMessage") {
                // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
                if (chatEnabled && data.chatTarget === chatTarget) {
                    addChatMessage(data.sender, data.message);
                }
            } else if (data.type === 'hideWidget') {
                // WidgetManagerì—ì„œ ë³´ë‚´ëŠ” ìˆ¨ê¹€ ë©”ì‹œì§€ ì²˜ë¦¬
                hideWidget();
            } else if (data.type === 'showWidget') {
                // WidgetManagerì—ì„œ ë³´ë‚´ëŠ” í‘œì‹œ ë©”ì‹œì§€ ì²˜ë¦¬
                revealWidget();
            } else if (data.type === 'spyResult') {
                showSpyResult(data.targetName, data.targetJob, data.isMafia, data.canUseAgain, data.enableMafiaChat);
            }
        });

        window.addEventListener('unload', function () {
            window.parent.focus();
        });

        // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€
        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile');
            } else {
                document.body.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // ìŠ¤íŒŒì´ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showSpyResult(targetName, targetJob, isMafia, canUseAgain, enableMafiaChat) {
            document.getElementById('players-list').style.display = 'none';
            document.getElementById('action-button').style.display = 'none';

            // ê²°ê³¼ì°½ í‘œì‹œ
            document.getElementById('result-container').style.display = 'block';

            // ê²°ê³¼ íƒ€ì´í‹€ ì„¤ì •
            document.getElementById('result-title').textContent = "ìŠ¤íŒŒì´ ì •ë³´ ìˆ˜ì§‘ ê²°ê³¼";

            // ê²°ê³¼ ë©”ì‹œì§€ êµ¬ì„±
            let resultMessage = `<strong>${targetName}</strong>ë‹˜ì˜ ì§ì—…ì€ <strong>${targetJob}</strong>ì…ë‹ˆë‹¤.`;

            if (isMafia) {
                resultMessage += '<br><span style="color: #ff4d4d;">ë§ˆí”¼ì•„ íŒ€</span>ì…ë‹ˆë‹¤.';
            } else {
                resultMessage += '<br><span style="color: #4da6ff;">ì‹œë¯¼ íŒ€</span>ì…ë‹ˆë‹¤.';
            }

            if (canUseAgain) {
                resultMessage += '<br><br><span style="color: #ffcc00;">ë§ˆí”¼ì•„ì™€ ì ‘ì„ ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ëŠ¥ë ¥ì„ í•œ ë²ˆ ë” ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>';

                // ëŠ¥ë ¥ ì¬ì‚¬ìš© ë²„íŠ¼ í‘œì‹œ
                document.getElementById('action-again-btn').style.display = 'block';
                document.getElementById('action-again-btn').onclick = function () {
                    document.getElementById('players-list').style.display = 'block';
                    document.getElementById('action-button').style.display = 'block';

                    document.getElementById('result-container').style.display = 'none';
                };

                // ë§ˆí”¼ì•„ ì±„íŒ… í™œì„±í™”
                if (enableMafiaChat) {
                    resultMessage += '<br><span style="color: #ffcc00;">ë§ˆí”¼ì•„ì™€ ì±„íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span>';

                    // ë§ˆí”¼ì•„ ì±„íŒ… ì´ˆê¸°í™” (ë‚˜ì¤‘ì— ì±„íŒ… UIê°€ ìë™ìœ¼ë¡œ í‘œì‹œë¨)
                    const roleAction = roleActions["spy"];
                    roleAction.showChat = true;

                    // ì„œë²„ì— ì±„íŒ… ì´ˆê¸°í™” ë©”ì‹œì§€ ì „ì†¡
                    window.parent.postMessage({
                        type: "initChat",
                        chatTarget: "mafia"
                    }, "*");
                }
            } else {
                document.getElementById('action-again-btn').style.display = 'none';
            }

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('result-content').innerHTML = resultMessage;
        }
    </script>
</body>

</html>